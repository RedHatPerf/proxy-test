- name: Create template
  template:
    src: resources.yaml.j2
    dest: /tmp/resources.yaml
- name: Make sure we are in correct namespace
  command: oc project {{ namespace }}
- name: Apply template
  command: oc apply -f /tmp/resources.yaml
- name: Find existing backend image
  shell: oc get images -n {{ namespace }} | grep "{{ namespace}}/mannequin@"
  register: existing_backend
  ignore_errors: true
- name: Build backend
  when: existing_backend is failed
  command: oc start-build mannequin-builder
- name: Make sure backend is scaled up
  command: oc scale dc backend --replicas=1
- name: Wait for backend to come up
  uri:
    url: "http://backend.{{ wildcard_domain }}"
    status_code: "204"
  register: backend_status
  until: backend_status is succeeded
  delay: 3
  retries: 20